{
    "componentChunkName": "component---src-templates-blog-post-tsx",
    "path": "/20220210-what3idols-yarn3/",
    "result": {"data":{"site":{"siteMetadata":{"title":".ごっちの日記","siteUrl":"https://yutagoto.github.io"}},"markdownRemark":{"id":"5a9cac4b-67aa-5a51-a6b2-80885985a35a","excerpt":"こんにちは、.ごっちです。 アイマスもくもく会を通じて What3Idols というサービス(?)の開発をし続けているのですが、勉強がてら yarn のバージョンを v1.22.XX から v3.1.1 にアップグレードさせました。 https://github.com/YutaGoto/what3idols Yarn…","html":"<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; margin: 0\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/blog/static/9bace5c2fc8a9bd04f7854022af19011/0579b/yarn.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 44.93670886075949%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsTAAALEwEAmpwYAAACHElEQVQoz32SS2iTQRDHN4oXRRCxSkGLtjGmmS9GitqDtiJSRLwoIkpFpAcL4qugKBUErWjz+GbTF1USEZS2aqn4xHzfbBKrQU209QEePPQggt4EDx7i4duVTfYgBT38mWV258fsf4YBEmMtcRbm4pTFxUxDzJGBhPstzEVv0HbnW1wwQPLpd3/JZzRnVo6xzcOTzOJiIoSkgrar9o+WZFu6oIIJV4W5KFpcLJwF+680rAuQVCSZ/X14YtprHyup4w/ee82D+XKjTcriog+qXS4CpCWmcDkgWYC0B5BqTB50x/qrM4GEq7ZfL3gd41Nqac8TeeD2G9V6ddIzwK8WFyssTh2AdBSQdgDSkIHdBaQeQIoD0ghwqtVA6Y87FUhbuiDX9WXVkfvvpD/myIaYo4E/AakFkM4B0hkDOwtIp03uAnAdxTFAOslCNn1p6s+pjvEpT3e6KprRcNn16KO3b7So1iTc7xsH8zUWF4cAyQGkNCB1A9J5QIoA0iXgpO9aAekiCyTc7vUDOXXi4YfyttQL2TyUV+1jJdmb/1zefeu1Wh13UnVXnmqvtVePAanWQsHM9CuxctZRD2XXzVdzg7br7rzxUnXem1YH77yVe0eKam1SqPqY82nDQG5ZuFqsPXQBxQIDqqyOAfoM0MciySzbNPxs3spo5nJ9NPPDH3OUP+78arQpteXa88VN/VkWqgLqAGkroIaLf67NH44hXYTZHdF2AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"yarn\"\n        title=\"yarn\"\n        src=\"/blog/static/9bace5c2fc8a9bd04f7854022af19011/f058b/yarn.png\"\n        srcset=\"/blog/static/9bace5c2fc8a9bd04f7854022af19011/c26ae/yarn.png 158w,\n/blog/static/9bace5c2fc8a9bd04f7854022af19011/6bdcf/yarn.png 315w,\n/blog/static/9bace5c2fc8a9bd04f7854022af19011/f058b/yarn.png 630w,\n/blog/static/9bace5c2fc8a9bd04f7854022af19011/40601/yarn.png 945w,\n/blog/static/9bace5c2fc8a9bd04f7854022af19011/78612/yarn.png 1260w,\n/blog/static/9bace5c2fc8a9bd04f7854022af19011/0579b/yarn.png 4812w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>こんにちは、.ごっちです。</p>\n<p><a href=\"https://github.com/imas/mokumoku\">アイマスもくもく会</a>を通じて <a href=\"https://what3idols.vercel.app/\">What3Idols</a> というサービス(?)の開発をし続けているのですが、勉強がてら yarn のバージョンを v1.22.XX から v3.1.1 にアップグレードさせました。</p>\n<p><a href=\"https://github.com/YutaGoto/what3idols\">https://github.com/YutaGoto/what3idols</a></p>\n<h2>Yarn 2, 3 の話</h2>\n<p>yarn 自体は普段のお仕事でもだいぶ使用していますが、どれも v1 系を使用していて、v2 v3 を使用している現場は全くと言っていいほど見かけません（もちろん使っている現場もあるとは思っています。見かけていないだけです。）。</p>\n<p>v1 と v2, v3 の差や特徴に関してはほかの記事をみてだいぶ勉強になりました。</p>\n<p><a href=\"https://www.wantedly.com/companies/wantedly/post_articles/325643\">https://www.wantedly.com/companies/wantedly/post_articles/325643</a></p>\n<p>メンテナーのブログもあるのでこちらも確認しました。</p>\n<ul>\n<li>v2: <a href=\"https://dev.to/arcanis/introducing-yarn-2-4eh1\">https://dev.to/arcanis/introducing-yarn-2-4eh1</a></li>\n<li>v3: <a href=\"https://dev.to/arcanis/yarn-3-0-performances-esbuild-better-patches-e07\">https://dev.to/arcanis/yarn-3-0-performances-esbuild-better-patches-e07</a></li>\n</ul>\n<p>個人的な認識としては、v2 から PnP(Plug’n Play)モードが使用できるということです。 <code class=\"language-text\">yarn install</code> したパッケージを <code class=\"language-text\">node_modules</code>に展開するのではなく、 zip に圧縮して <code class=\"language-text\">.yarn/cache</code> に並べるモードです。こうすることによって、ファイル数が圧倒的に少なくなるほか、容量もそこまで大きくならなくなります。</p>\n<p>また、 <code class=\"language-text\">Zero-Installs</code> というワークフローもあり、 <code class=\"language-text\">.yarn/cache</code> の中身もすべて git にコミットするというなかなか激しいパターンも取れます。これは <code class=\"language-text\">yarn install</code> せずともにすぐに Script を動かせるようになったり、他社や本番環境などとでライブラリそのものに差をなくすといったメリットがあります。ただ、コミットファイル量がやばいことになります。\n<code class=\"language-text\">Yarn</code> プロジェクトも PnP + Zero-Installs モードでやっていますが、 <code class=\"language-text\">.yarn/cache</code> ディレクトリはけっこう激しいです。 <a href=\"https://github.com/yarnpkg/berry/tree/master/.yarn/cache\">https://github.com/yarnpkg/berry/tree/master/.yarn/cache</a></p>\n<h2>What3Idols での移行手順</h2>\n<h3>使用する yarn のバージョンを 3 にセットする</h3>\n<p><code class=\"language-text\">berry</code> を指定すると現状リリースされている最新バージョンの安定板をセットできます。もちろん、直接バージョン番号を指定できます。</p>\n<p><a href=\"https://yarnpkg.com/cli/set/version\">https://yarnpkg.com/cli/set/version</a></p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">$ <span class=\"token function\">yarn</span> <span class=\"token builtin class-name\">set</span> version berry\n$ <span class=\"token function\">yarn</span> -v\n<span class=\"token number\">3.1</span>.1</code></pre></div>\n<h3><code class=\"language-text\">node_modules</code> を使用しない設定をする</h3>\n<p>この状態ですと、引き続き <code class=\"language-text\">node_modules</code> を使用する設定になっているはずなので変更をします。</p>\n<p><code class=\"language-text\">.yarnrc.yml</code> の<code class=\"language-text\">nodeLinker</code> を削除します。これで PnP モードを使用できるようになります。削除すると <code class=\"language-text\">yarnPath</code> だけが残っているはずです。</p>\n<div class=\"gatsby-highlight\" data-language=\"yml\"><pre class=\"language-yml\"><code class=\"language-yml\"><span class=\"token comment\"># .yarnrc.yml</span>\n<span class=\"token key atrule\">yarnPath</span><span class=\"token punctuation\">:</span> .yarn/releases/yarn<span class=\"token punctuation\">-</span>3.1.1.cjs</code></pre></div>\n<h3><code class=\"language-text\">.gitignore</code></h3>\n<p>What3Idols プロジェクトでは <code class=\"language-text\">Zero-Installs</code> に則るので <code class=\"language-text\">.gitignore</code> もドキュメントにあるように変更をします。</p>\n<p><a href=\"https://yarnpkg.com/getting-started/qa#which-files-should-be-gitignored\">https://yarnpkg.com/getting-started/qa#which-files-should-be-gitignored</a></p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\"># .gitignore\n# yarn3 with Zero-install (追記)\n.yarn/*\n!.yarn/cache\n!.yarn/patches\n!.yarn/plugins\n!.yarn/releases\n!.yarn/sdks\n!.yarn/versions</code></pre></div>\n<h3>CircleCI の設定</h3>\n<p>CI でも <code class=\"language-text\">yarn install</code> のステップを使用しないので書き換えます。</p>\n<p><a href=\"https://circleci.com/developer/ja/orbs/orb/circleci/node#usage-yarn_berry_zero_install\">https://circleci.com/developer/ja/orbs/orb/circleci/node#usage-yarn_berry_zero_install</a></p>\n<div class=\"gatsby-highlight\" data-language=\"yml\"><pre class=\"language-yml\"><code class=\"language-yml\"><span class=\"token comment\"># .circleci/config.yml</span>\n<span class=\"token comment\"># yarn install していた部分を書き換える</span>\n<span class=\"token punctuation\">-</span> <span class=\"token key atrule\">node/install-packages</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">check-cache</span><span class=\"token punctuation\">:</span> always\n    <span class=\"token key atrule\">pkg-manager</span><span class=\"token punctuation\">:</span> yarn<span class=\"token punctuation\">-</span>berry\n    <span class=\"token key atrule\">with-cache</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">false</span></code></pre></div>\n<h3>そのほか設定</h3>\n<p>この状態で起動したところ下記エラーが発生しました。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">error - .yarn/__virtual__/react-bulma-components-virtual-92c18f60ac/0/cache/react-bulma-components-npm-4.1.0-ebd88e4a93-7d0165d60d.zip/node_modules/react-bulma-components/cjs/components/breadcrumb/breadcrumb.js:10:0\nModule not found: react-bulma-components tried to access prop-types (a peer dependency) but it isn't provided by your application; this makes the require call ambiguous and unsound.</code></pre></div>\n<p><code class=\"language-text\">react-bulma-components</code> が <code class=\"language-text\">prop-types</code> を呼び出そうとしたが呼び出せず、 require 呼び出しがあいまいになってしまったエラーのようです。手動であいまいな部分を設定する必要があります。\nyarn のドキュメントを見ながら <code class=\"language-text\">.yarnrc.yml</code> に追記します。</p>\n<p><a href=\"https://yarnpkg.com/getting-started/migration#fix-dependencies-with-packageextensions\">https://yarnpkg.com/getting-started/migration#fix-dependencies-with-packageextensions</a>\n<a href=\"https://yarnpkg.com/configuration/yarnrc#packageExtensions\">https://yarnpkg.com/configuration/yarnrc#packageExtensions</a></p>\n<div class=\"gatsby-highlight\" data-language=\"yml\"><pre class=\"language-yml\"><code class=\"language-yml\"><span class=\"token comment\"># .yarnrc.yml</span>\n<span class=\"token key atrule\">packageExtensions</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">\"react-bulma-components@*\"</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">dependencies</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">\"prop-types\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"*\"</span></code></pre></div>\n<h3>Dependabot</h3>\n<p>ライブラリの更新のプルリクエストの作成を Dependabot でやってたのですが、 2022/02/10 現在では<a href=\"https://docs.github.com/ja/code-security/supply-chain-security/keeping-your-dependencies-updated-automatically/about-dependabot-version-updates#supported-repositories-and-ecosystems\">yarn2, 3</a>には対応していないので、<a href=\"https://depfu.com/\">Depfu</a>というサービスに乗り換えました。</p>\n<h2>移行完了</h2>\n<p>この状態で <code class=\"language-text\">yarn dev</code> を実行し、localhost にアクセスすると無事にページが表示されます。\ncommit して Vercel にデプロイしても問題なく完了し表示させることができました。</p>","fields":{"slug":"/20220210-what3idols-yarn3/"},"frontmatter":{"title":"What3IdolsプロジェクトをYarn v3へアップグレード","date":"February 10, 2022","description":"Yarn v1 -> Yarn v3","tags":["アイドルマスター","What3Idols","yarn"]}},"previous":{"fields":{"slug":"/20220115-difficult-game-p/"},"frontmatter":{"title":"かなり難しいゲームの一つのステージをクリアしたメモ"}},"next":{"fields":{"slug":"/20220301-agrienta-plastic-hot-house/"},"frontmatter":{"title":"農家さんの手伝いに行った"}}},"pageContext":{"id":"5a9cac4b-67aa-5a51-a6b2-80885985a35a","previousPostId":"060d7c21-a609-545d-b532-6c02e2c405a8","nextPostId":"7e7e5495-16ef-529b-ace8-af8ef5c83e83"}},
    "staticQueryHashes": ["2137539840","2183174749"]}